<script lang="ts">
	import { getCredentials, login, logout } from '$lib/api/session';
	import type { Credentials } from '$lib/api/session';
	import { onMount } from 'svelte';
	import { faRightFromBracket } from '@fortawesome/free-solid-svg-icons';
	import Dialog from '../Dialog.svelte';
	import Icon from '../Icon.svelte';
	import type { EventHandler } from 'svelte/elements';

	let message: string | null = null;
	let credentials: Credentials | null = null;

	// eslint-disable-next-line @typescript-eslint/no-explicit-any
	async function handleSubmit(e: any) {
		const formData = new FormData(e.target);

		const schoolnumber = formData.get('schoolnumber');
		const username = formData.get('username');
		const password = formData.get('password');

		if (!schoolnumber || !username || !password) {
			return (message = 'Bitte fülle alle Felder aus.');
		}

		const data = {
			schoolnumber: schoolnumber.toString(),
			username: username as 'schueler' | 'lehrer',
			password: password.toString()
		};

		login(data).then((res) => {
			if (res === 200) return location.reload();
			if (res === 401) return (message = 'Zugangsdaten konnten nicht verifiziert werden.');
			if (res === 404) return (message = 'Die Schulnummer konnte nicht gefunden werden.');
			message = 'Es ist ein Fehler aufgetreten.';
		});
	}

	function handleLogout() {
		logout();
	}

	onMount(() => {
		credentials = getCredentials();
		// if (credentials) {
		// 	document.querySelector('#loginDialog_schoolnumber').value = credentials.schoolnumber;
		// 	document.querySelector('#loginDialog_username').value = credentials.username;
		// 	document.querySelector('#loginDialog_password').value = credentials.password;
		// }
	});
</script>

<Dialog id="loginDialog" let:element>
	<h1 class="text-center">Zugangsdaten</h1>
	<form class="mt-4 flex flex-col gap-2" on:submit|preventDefault={handleSubmit}>
		<input
			type="text"
			id="loginDialog_schoolnumber"
			name="schoolnumber"
			placeholder="Schulnummer"
			value={credentials && credentials.schoolnumber}
		/>
		<select class="input" id="loginDialog_username" name="username" 
			value={credentials && credentials.username}
		>
			<option value="schueler" selected>Schüler</option>
			<option value="lehrer">Lehrer</option>
		</select>
		<input type="password" id="loginDialog_password" name="password" placeholder="Password" 
			value={credentials && credentials.password}
		/>
		<div class="mt-4 grid grid-cols-4 gap-4">
			{#if credentials}
				<input
					class="input col-span-3 cursor-pointer opacity-60"
					type="button"
					value="Schließen"
					on:click={() => element.close()}
				/>
			{/if}
			{#if credentials}
				<button
					class="col-span-1 flex cursor-pointer items-center justify-center rounded-[7px] border-[3px] border-error"
					on:click={handleLogout}
				>
					<Icon icon={faRightFromBracket} size={1.5} />
				</button>
			{/if}
			<input class="input col-span-4 cursor-pointer" type="submit" value="Speichern" />
		</div>
	</form>
	{#if message}
		<p class="mt-4 text-center text-lg font-bold text-error">{message}</p>
	{/if}
</Dialog>
